<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-standards/deepbookv3/design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">DeepBook Design | Sui Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.sui.io/img/sui-doc-og.png"><meta data-rh="true" name="twitter:image" content="https://docs.sui.io/img/sui-doc-og.png"><meta data-rh="true" property="og:url" content="https://docs.sui.io/standards/deepbookv3/design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="DeepBook Design | Sui Documentation"><meta data-rh="true" name="description" content="At a high level, the DeepBook design follows the following flow, which revolves around three shared objects:"><meta data-rh="true" property="og:description" content="At a high level, the DeepBook design follows the following flow, which revolves around three shared objects:"><link data-rh="true" rel="icon" href="../../img/favicon.ico"><link data-rh="true" rel="canonical" href="design.html"><link data-rh="true" rel="alternate" href="design.html" hreflang="en"><link data-rh="true" rel="alternate" href="design.html" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZF283DJAYX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Sui Documentation" href="../../opensearch.xml">
<link rel="preconnect" href="https://us.i.posthog.com">
<script>!function(t,e){var o,s,r,a;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,n,p){function c(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(r=t.createElement("script")).type="text/javascript",r.async=!0,r.src=n.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(a=t.getElementsByTagName("script")[0]).parentNode.insertBefore(r,a);var g=e;for(void 0!==p?g=e[p]=[]:p="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==p&&(e+="."+p),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),s=0;s<o.length;s++)c(g,o[s]);e._i.push([i,n,p])},e.__SV=1)}(document,window.posthog||[]),posthog.init("phc_9Ny8QzZBTmsZh0ucEhdknMivaJhATZjbplVVaiirA9T",{api_host:"https://us.i.posthog.com",id:"default"})</script>










<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="../../assets/css/styles.e5383d0f.css">
<script src="../../assets/js/runtime~main.c6758a96.js" defer="defer"></script>
<script src="../../assets/js/main.5a96279b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_y7Zq" href="design.html#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="../../index.html"><div class="navbar__logo"><img src="../../img/sui-logo.svg" alt="Sui Docs Logo" class="themedComponent_fc7v themedComponent--light_SFoa"><img src="../../img/sui-logo.svg" alt="Sui Docs Logo" class="themedComponent_fc7v themedComponent--dark_o7dU"></div><b class="navbar__title text--truncate">Sui Documentation</b></a><div class="flex flex-[8_1_0%] items-center justify-start gap-8 min-[1100px]:gap-16"><a class="navbar__item navbar__link" href="../../guides.html">Guides</a><a class="navbar__item navbar__link" href="../../concepts.html">Concepts</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="../../standards.html">Standards</a><a class="navbar__item navbar__link" href="../../references.html">References</a></div></div><div class="navbar__items navbar__items--right"><div class="flex flex-[8_1_0%] items-center justify-start gap-8 min-[1100px]:gap-16"></div><div class="theme-toggle-wrapper text-white max-[996px]:hidden"><div class="toggle_sgcG"><button class="clean-btn toggleButton_PfWu toggleButtonDisabled_keYU" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pMyg"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_k_Wp"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div><div class="navbarSearchContainer_hdzx"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_obr0"><div class="docsWrapper_cx5y"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_ixAB" type="button"></button><div class="docRoot_o73X"><aside class="theme-doc-sidebar-container docSidebarContainer_sVsO"><div class="sidebarViewport_A_mM"><div class="sidebar_dLPM"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_CWUi"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="../../standards.html">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="../coin.html">Coin</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="../closed-loop-token.html">Closed-Loop Token</a><button aria-label="Expand sidebar category &#x27;Closed-Loop Token&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="../kiosk.html">Sui Kiosk</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="../kiosk-apps.html">Kiosk Apps</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="../deepbook.html">DeepBook</a><button aria-label="Collapse sidebar category &#x27;DeepBook&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="../deepbookv3.html">DeepBookV3</a><button aria-label="Collapse sidebar category &#x27;DeepBookV3&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="design.html">Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="balance-manager.html">BalanceManager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="permissionless-pool.html">Permissionless Pool Creation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="query-the-pool.html">Query the Pool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="orders.html">Orders</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="swaps.html">Swaps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="flash-loans.html">Flash Loans</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="staking-governance.html">Staking and Governance</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="../deepbookv3-indexer.html">DeepBookV3 Indexer</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="../deepbookv3-sdk.html">DeepBookV3 SDK</a><button aria-label="Expand sidebar category &#x27;DeepBookV3 SDK&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="../deepbookv2.html">DeepBookV2</a><button aria-label="Expand sidebar category &#x27;DeepBookV2&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="../display.html">Sui Object Display</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="../wallet-standard.html">Wallet Standard</a></li></ul></nav></div></div></aside><main class="docMainContainer_DePh"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Iw6L"><div class="docItemContainer_ausd"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_yIz6" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="../../index.html"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_prGD"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="../deepbook.html"><span itemprop="name">DeepBook</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="../deepbookv3.html"><span itemprop="name">DeepBookV3</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Design</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_Eyz5 theme-doc-toc-mobile tocMobile_BcqM"><button type="button" class="clean-btn tocCollapsibleButton_PRt6">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>DeepBook Design</h1></header><p>At a high level, the DeepBook design follows the following flow, which revolves around three shared objects:</p>
<ul>
<li><code>Pool</code>: A shared object that represents one market and is responsible for managing its order book, users, stakes, and so on. See the <a href="design.html#pool">Pool shared object</a> section to learn more.</li>
<li><code>PoolRegistry</code>: Used only during pool creation, it makes sure that duplicate pools are not created and maintains package versioning.</li>
<li><code>BalanceManager</code>: Used to source a user&#x27;s funds when placing orders. A single <code>BalanceManager</code> can be used between all pools. See <a href="balance-manager.html">BalanceManager</a> to learn more.</li>
</ul>
<p class="flex justify-center"><img decoding="async" loading="lazy" alt="1" src="../../assets/images/DBv3Architecture-65523469d7d2de40637da8d3675bf996.png" width="800" height="930" class="img_koxB"></p>
<h2 class="anchor anchorWithStickyNavbar_uDrR" id="pool">Pool shared object<a href="design.html#pool" class="hash-link" aria-label="Direct link to Pool shared object" title="Direct link to Pool shared object">​</a></h2>
<p>All public facing functions take in the <code>Pool</code> shared object as a mutable or immutable reference. <code>Pool</code> is made up of three distinct components:</p>
<ul>
<li><a href="design.html#book"><code>Book</code></a></li>
<li><a href="design.html#state"><code>State</code></a></li>
<li><a href="design.html#vault"><code>Vault</code></a></li>
</ul>
<p>Logic is isolated between components and each component builds on top of the previous one. By maintaining a book, then state, then vault relationship, DeepBook can provide data availability guarantees, improve code readability, and help make maintaining and upgrading the protocol easier.</p>
<p class="flex justify-center"><img decoding="async" loading="lazy" alt="Pool Modules" src="../../assets/images/pool-e04c69f5f1bb6fac875581fe0ea421de.png" width="800" height="417" class="img_koxB"></p>
<h3 class="anchor anchorWithStickyNavbar_uDrR" id="book">Book<a href="design.html#book" class="hash-link" aria-label="Direct link to Book" title="Direct link to Book">​</a></h3>
<p>This component is made up of the main <code>Book</code> module along with <code>Fill</code>, <code>OrderInfo</code>, and <code>Order</code> modules. The <code>Book</code> struct maintains two <code>BigVector&lt;Order&gt;</code> objects for bids and asks, as well as some metadata. It is responsible for storing, matching, modifying, and removing <code>Orders</code>.</p>
<p>When placing an order, an <code>OrderInfo</code> is first created. If applicable, it is first matched against existing maker orders, accumulating <code>Fill</code>s in the process. Any remaining quantity will be used to create an <code>Order</code> object and injected into the book. By the end of book processing, the <code>OrderInfo</code> object has enough information to update all relevant users and the overall state.</p>
<h3 class="anchor anchorWithStickyNavbar_uDrR" id="state">State<a href="design.html#state" class="hash-link" aria-label="Direct link to State" title="Direct link to State">​</a></h3>
<p><code>State</code> stores <code>Governance</code>, <code>History</code>, and <code>Account</code>. It processes all requests, updating at least one of these stored structs.</p>
<h4 class="anchor anchorWithStickyNavbar_uDrR" id="governance">Governance<a href="design.html#governance" class="hash-link" aria-label="Direct link to Governance" title="Direct link to Governance">​</a></h4>
<p>The <code>Governance</code> module stores data related to the pool&#x27;s trading params. These parameters are the taker fee, maker fee, and the stake required. Stake required represents the amount of DEEP tokens that a user must have staked in this specific pool to be eligible for taker and maker incentives.</p>
<p>Every epoch, users with non zero stake can submit a proposal to change these parameters. The proposed fees are bounded.</p>
<style>
table {
  width: 100%;
  display: inline-table;
}
th:nth-child(1),
td:nth-child(1) {
  width: 15%;
}
th:nth-child(2),
td:nth-child(2) {
  width: 15%;
}
</style>
<table><thead><tr><th>min_value (bps)</th><th>max_value (bps)</th><th>Pool type</th><th>Taker or maker</th></tr></thead><tbody><tr><td>1</td><td>10</td><td>Volatile</td><td>Taker</td></tr><tr><td>0</td><td>5</td><td>Volatile</td><td>Maker</td></tr><tr><td>0.1</td><td>1</td><td>Stable</td><td>Taker</td></tr><tr><td>0</td><td>0.5</td><td>Stable</td><td>Maker</td></tr><tr><td>0</td><td>0</td><td>Whitelisted</td><td>Taker and maker</td></tr></tbody></table>
<p>Users can also vote on live proposals. When a proposal exceeds the quorum, the new trade parameters are queued to go live from the following epoch and onwards.  Proposals and votes are reset every epoch. Users can start submitting and voting on proposals the epoch following their stake. Quorum is equivalent to half of the total voting power. A user&#x27;s voting power is calculated with the following formula where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em">V</span></span></span></span></span> is the voting power, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em">S</span></span></span></span></span> is the amount staked, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">{V_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> is the voting power cutoff. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">{V_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s"> ​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> is currently set to 100,000 DEEP.</p>
<p class="flex justify-center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathsize="1.728em"><mi>V</mi><mo>=</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><msub><mi>V</mi><mi>c</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msqrt><mi>S</mi></msqrt><mo>−</mo><msqrt><msub><mi>V</mi><mi>c</mi></msub></msqrt><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">\LARGE V=\min\lparen S,V_c \rparen + \max\lparen \sqrt{S} - \sqrt{V_c} ,0 \rparen</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1808em"></span><span class="mord mathnormal sizing reset-size6 size9" style="margin-right:0.22222em">V</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel sizing reset-size6 size9">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.728em;vertical-align:-0.432em"></span><span class="mop sizing reset-size6 size9">min</span><span class="mopen sizing reset-size6 size9">(</span><span class="mord mathnormal sizing reset-size6 size9" style="margin-right:0.05764em">S</span><span class="mpunct sizing reset-size6 size9">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord sizing reset-size6 size9"><span class="mord mathnormal" style="margin-right:0.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.149em"><span style="top:-3.05em;margin-left:-0.2222em;margin-right:0.0289em"><span class="pstrut" style="height:3.2em"></span><span class="sizing reset-size9 size7 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose sizing reset-size6 size9">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin sizing reset-size6 size9">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:2.0333em;vertical-align:-0.432em"></span><span class="mop sizing reset-size6 size9">max</span><span class="mopen sizing reset-size6 size9">(</span><span class="mord sqrt sizing reset-size6 size9"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9267em"><span class="svg-align" style="top:-3.728em"><span class="pstrut" style="height:3.728em"></span><span class="mord" style="padding-left:0.833em"><span class="mord mathnormal" style="margin-right:0.05764em">S</span></span></span><span style="top:-3.6147em"><span class="pstrut" style="height:3.728em"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1133em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin sizing reset-size6 size9">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.9037em;vertical-align:-0.432em"></span><span class="mord sqrt sizing reset-size6 size9"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8517em"><span class="svg-align" style="top:-3.728em"><span class="pstrut" style="height:3.728em"></span><span class="mord" style="padding-left:0.833em"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.149em"><span style="top:-3.05em;margin-left:-0.2222em;margin-right:0.0289em"><span class="pstrut" style="height:3.2em"></span><span class="sizing reset-size9 size7 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.5397em"><span class="pstrut" style="height:3.728em"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1883em"><span></span></span></span></span></span><span class="mpunct sizing reset-size6 size9">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord sizing reset-size6 size9">0</span><span class="mclose sizing reset-size6 size9">)</span></span></span></span></p>
<p>The following diagram helps visualize the governance lifecycle.</p>
<p class="flex justify-center"><img decoding="async" loading="lazy" alt="DeepBook Governance Timeline" src="../../assets/images/governance-166bcc0f64efe0075432b3afc50f1f0a.png" width="2292" height="1112" class="img_koxB"></p>
<h4 class="anchor anchorWithStickyNavbar_uDrR" id="history">History<a href="design.html#history" class="hash-link" aria-label="Direct link to History" title="Direct link to History">​</a></h4>
<p>The <code>History</code> module stores aggregated volumes, trading params, fees collected and fees to burn for the current epoch and previous epochs. During order processing, fills are used to calculate and update the total volume. Additionally, if the maker of the trade has enough stake, the total staked volume is also updated.</p>
<p>The first operation of every epoch will trigger an update, moving the current epoch data into historic data, and resetting the current epoch data.</p>
<p>User rebate calculations are done in this module. During every epoch, a maker is eligible for rebates as long as their DEEP staked is over the stake required and have contributed in maker volume. The following formula is used to calculate maker fees, quoted from the <a href="../../assets/files/deepbook-3e24e6e1deeb8cd860682c1fb473b597.pdf" target="_blank">Whitepaper: DeepBook Token</a> document. Details on maker incentives can be found in section 2.2 of the whitepaper.</p>
<blockquote cite="/doc/deepbook.pdf"><p>The computation of incentives – which happens after an epoch ends and is only given to makers
who have staked the required number of DEEP tokens in advance – is calculated in Equation (3) for
a given maker <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord"><span class="mord mathnormal">i</span></span></span></span></span>. Equation (3) introduces several new variables. First, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em">M</span></span></span></span></span> refers to the set of makers
who stake a sufficient number of DEEP tokens, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>M</mi><mo>ˉ</mo></mover></mrow><annotation encoding="application/x-tex">\bar{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8201em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8201em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.10903em">M</span></span><span style="top:-3.2523em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.1667em"><span class="mord">ˉ</span></span></span></span></span></span></span></span></span></span> refers to the set of makers who do not fulfill
this condition. Second, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">{F}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em">F</span></span></span></span></span> refers to total fees (collected both from takers and the maker) that a
maker’s volume has generated in a given epoch. Third, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">{L}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord"><span class="mord mathnormal">L</span></span></span></span></span> refers to the total liquidity provided by
a maker – and specifically the liquidity traded, not just the liquidity quoted. Finally, the critical
point <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">{p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span></span></span></span></span> is the “phaseout” point, at which – if total liquidity provided by other makers’ crosses this
point – incentives are zero for the maker in that epoch. This point <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">{p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span></span></span></span></span> is constant for all makers in
a pool and epoch.</p><p class="flex justify-center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathsize="1.728em"><mrow><mtext mathvariant="sans-serif">Incentives</mtext><mtext> </mtext></mrow><mrow><mtext mathvariant="sans-serif">for</mtext><mtext> </mtext></mrow><mrow><mtext mathvariant="sans-serif">Maker</mtext><mtext> </mtext></mrow><mi>i</mi><mo>=</mo><mi>max</mi><mo>⁡</mo><mo fence="false" stretchy="true" minsize="3em" maxsize="3em">[</mo><msub><mi>F</mi><mi>i</mi></msub><mo fence="false" stretchy="true" minsize="3em" maxsize="3em">(</mo><mn>1</mn><mo>+</mo><mstyle mathsize="1.2em"><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><msub><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><mover accent="true"><mi>M</mi><mo>ˉ</mo></mover></mrow></msub><msub><mi>F</mi><mi>j</mi></msub></mrow><mrow><msub><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><mi>M</mi></mrow></msub><msub><mi>F</mi><mi>j</mi></msub></mrow></mfrac></mstyle><mo fence="false" stretchy="true" minsize="3em" maxsize="3em">)</mo><mo fence="false" stretchy="true" minsize="3em" maxsize="3em">(</mo><mstyle mathsize="1.728em"><mn>1</mn><mo>−</mo><mstyle mathsize="1.2em"><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><msub><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><mi>M</mi><mo>∪</mo><mover accent="true"><mi>M</mi><mo>ˉ</mo></mover></mrow></msub><msub><mi>L</mi><mi>j</mi></msub><mo>−</mo><msub><mi>L</mi><mi>i</mi></msub></mrow><mi>p</mi></mfrac></mstyle><mo fence="false" stretchy="true" minsize="3em" maxsize="3em">)</mo><mstyle mathsize="1.728em"><mo separator="true">,</mo><mn>0</mn><mo fence="false" stretchy="true" minsize="3em" maxsize="3em">]</mo></mstyle></mstyle></mstyle></mstyle></mstyle></mrow><annotation encoding="application/x-tex">\LARGE \textsf {Incentives }  \textsf {for } \textsf {Maker } i = \max\Bigg\lbrack F_i\Bigg\lparen 1 + \large\cfrac{\sum_{j \in \bar{M}} F_j} {\sum_{j \in M} F_j} \Bigg\rparen\Bigg\lparen \LARGE 1 - \large\cfrac{\sum_{j \in M \cup \bar{M}} L_j - L_i}{p}\Bigg\rparen \LARGE ,0 \Bigg\rbrack</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2em"></span><span class="mord text sizing reset-size6 size9"><span class="mord textsf">Incentives </span></span><span class="mord text sizing reset-size6 size9"><span class="mord textsf">for </span></span><span class="mord text sizing reset-size6 size9"><span class="mord textsf">Maker </span></span><span class="mord mathnormal sizing reset-size6 size9">i</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel sizing reset-size6 size9">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em"></span><span class="mop sizing reset-size6 size9">max</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord sizing reset-size6 size6"><span class="delimsizing size4">[</span></span><span class="mord sizing reset-size6 size9"><span class="mord mathnormal" style="margin-right:0.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.308em"><span style="top:-3.05em;margin-left:-0.1389em;margin-right:0.0289em"><span class="pstrut" style="height:3.2em"></span><span class="sizing reset-size9 size7 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord sizing reset-size6 size6"><span class="delimsizing size4">(</span></span><span class="mord sizing reset-size6 size9">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin sizing reset-size6 size9">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:3.3359em;vertical-align:-1.3356em"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.667em"><span style="top:-2.514em"><span class="pstrut" style="height:3.2em"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1582em"><span style="top:-2.5027em;margin-left:0em;margin-right:0.0417em"><span class="pstrut" style="height:2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.427em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2897em"><span style="top:-2.65em;margin-left:-0.1389em;margin-right:0.0417em"><span class="pstrut" style="height:2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2796em"><span></span></span></span></span></span></span></span></span><span style="top:-3.43em"><span class="pstrut" style="height:3.2em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-4.017em"><span class="pstrut" style="height:3.2em"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2494em"><span style="top:-2.5027em;margin-left:0em;margin-right:0.0417em"><span class="pstrut" style="height:2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">∈</span><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8201em"><span style="top:-2.8em"><span class="pstrut" style="height:2.8em"></span><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span></span><span style="top:-3.0523em"><span class="pstrut" style="height:2.8em"></span><span class="accent-body" style="left:-0.1667em"><span class="mord mtight">ˉ</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.427em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2897em"><span style="top:-2.65em;margin-left:-0.1389em;margin-right:0.0417em"><span class="pstrut" style="height:2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2796em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.113em"><span></span></span></span></span></span><span></span></span><span class="mord sizing reset-size6 size6"><span class="delimsizing size4">)</span></span><span class="mord sizing reset-size6 size6"><span class="delimsizing size4">(</span></span><span class="mord sizing reset-size6 size9">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin sizing reset-size6 size9">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:3.2504em;vertical-align:-1.25em"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.667em"><span style="top:-2.514em"><span class="pstrut" style="height:3.2em"></span><span class="mord"><span class="mord mathnormal">p</span></span></span><span style="top:-3.43em"><span class="pstrut" style="height:3.2em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-4.017em"><span class="pstrut" style="height:3.2em"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2494em"><span style="top:-2.5027em;margin-left:0em;margin-right:0.0417em"><span class="pstrut" style="height:2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span><span class="mbin mtight">∪</span><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8201em"><span style="top:-2.8em"><span class="pstrut" style="height:2.8em"></span><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span></span><span style="top:-3.0523em"><span class="pstrut" style="height:2.8em"></span><span class="accent-body" style="left:-0.1667em"><span class="mord mtight">ˉ</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.427em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2897em"><span style="top:-2.65em;margin-left:0em;margin-right:0.0417em"><span class="pstrut" style="height:2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2796em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2897em"><span style="top:-2.65em;margin-left:0em;margin-right:0.0417em"><span class="pstrut" style="height:2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em"><span></span></span></span></span></span><span></span></span><span class="mord sizing reset-size6 size6"><span class="delimsizing size4">)</span></span><span class="mpunct sizing reset-size6 size9">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord sizing reset-size6 size9">0</span><span class="mord sizing reset-size6 size6"><span class="delimsizing size4">]</span></span></span></span></span> (3)</p></blockquote>
<p>In essence, if the total volume during an epoch is greater than the median volume from the last 28 days, then there are no rebates. The lower the volume compared to the median, the more rebates are available. The maximum amount of rebates for an epoch is equivalent to the total amount of DEEP collected during that epoch. Remaining DEEP is burned.</p>
<h4 class="anchor anchorWithStickyNavbar_uDrR" id="account">Account<a href="design.html#account" class="hash-link" aria-label="Direct link to Account" title="Direct link to Account">​</a></h4>
<p><code>Account</code> represents a single user and their relevant data. Everything related to volumes, stake, voted proposal, unclaimed rebates, and balances to be transferred. There is a one to one relationship between a <code>BalanceManager</code> and an <code>Account</code>.</p>
<p>Every epoch, the first action that a user performs will update their account, triggering a calculation of any potential rebates from the previous epoch, as well as resetting their volumes for the current epoch. Any new stakes from the previous epoch become active.</p>
<p>Each account has settled and owed balances. Settled balances are what the pool owes to the user, and owed balances are what the user owes to the pool. For example, when placing an order, the user&#x27;s owed balances increase, representing the funds that the user has to pay to place that order. Then, if a maker order is taken by another user, the maker&#x27;s settled balances increase, representing the funds that the maker is owed.</p>
<h3 class="anchor anchorWithStickyNavbar_uDrR" id="vault">Vault<a href="design.html#vault" class="hash-link" aria-label="Direct link to Vault" title="Direct link to Vault">​</a></h3>
<p>Every transaction that a user performs on DeepBook resets their settled and owed balances. The vault then processes these balances for the user, deducting or adding to funds to their <code>BalanceManager</code>.</p>
<p>The vault also stores the <code>DeepPrice</code> struct. This object holds up to 100 data points representing the conversion rate between the pool&#x27;s base or quote asset and DEEP. These data points are sourced from a whitelisted pool, DEEP/USDC or DEEP/SUI. This conversion rate is used to determine the quantity of DEEP tokens required to pay for trading fees.</p>
<h3 class="anchor anchorWithStickyNavbar_uDrR" id="bigvector">BigVector<a href="design.html#bigvector" class="hash-link" aria-label="Direct link to BigVector" title="Direct link to BigVector">​</a></h3>
<p><code>BigVector</code> is an arbitrary sized vector-like data structure, implemented using an on-chain B+ Tree to support almost constant time (log base max_fan_out) random access, insertion and removal.</p>
<p>Iteration is supported by exposing access to leaf nodes (slices). Finding the initial slice can be done in almost constant time, and subsequently finding the previous or next slice can also be done in constant time.</p>
<p>Nodes in the B+ Tree are stored as individual dynamic fields hanging off the <code>BigVector</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_uDrR" id="place-limit-order-flow">Place limit order flow<a href="design.html#place-limit-order-flow" class="hash-link" aria-label="Direct link to Place limit order flow" title="Direct link to Place limit order flow">​</a></h2>
<p>The following diagram of the lifecycle of an order placement action helps visualize the book, then state, then vault flow.</p>
<p class="flex justify-center"><img decoding="async" loading="lazy" alt="Place limit order flow" src="../../assets/images/placeorder-070837ca2be2d30e4a77afd64082957a.png" width="800" height="631" class="img_koxB"></p>
<h3 class="anchor anchorWithStickyNavbar_uDrR" id="pool">Pool<a href="design.html#pool" class="hash-link" aria-label="Direct link to Pool" title="Direct link to Pool">​</a></h3>
<p>In the <code>Pool</code> module, <code>place_order_int</code> is called with the user&#x27;s input parameters. In this function, four things happen in order:</p>
<ol>
<li>An <code>OrderInfo</code> is created.</li>
<li>The <code>Book</code> function <code>create_order</code> is called.</li>
<li>The <code>State</code> function <code>process_create</code> is called.</li>
<li>The <code>Vault</code> function <code>settle_balance_manager</code> is called.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_uDrR" id="book-1">Book<a href="design.html#book-1" class="hash-link" aria-label="Direct link to Book" title="Direct link to Book">​</a></h3>
<p>The order creation within the book involves three primary tasks:</p>
<ul>
<li>Validate inputs.</li>
<li>Match against existing orders.</li>
<li>Inject any remaining quantity into the order book as a limit order.</li>
</ul>
<p>Validation of inputs ensures that quantity, price, timestamp, and order type are within expected ranges.</p>
<p>To match an <code>OrderInfo</code> against the book, the list of <code>Order</code>s is iterated in the opposite side of the book. If there is an overlap in price and the existing maker order has not expired, then DeepBook matches their quantities and generates a <code>Fill</code>. DeepBook appends that fill to the <code>OrderInfo</code> fills, to use later in state. DeepBook updates the existing maker order quantities and status during each match, and removes them from the book if they are completely filled or expired.</p>
<p>Finally, if the <code>OrderInfo</code> object has any remaining quantity, DeepBook converts it into a compact <code>Order</code> object and injects it into the order book. <code>Order</code> has the minimum amount of data necessary for matching, while <code>OrderInfo</code> has the maximum amount of data for general processing.</p>
<p>Regardless of direction or order type, all DeepBook matching is processed in a single function.</p>
<h3 class="anchor anchorWithStickyNavbar_uDrR" id="state-1">State<a href="design.html#state-1" class="hash-link" aria-label="Direct link to State" title="Direct link to State">​</a></h3>
<p>The <code>process_create</code> function in <code>State</code> handles the processing of an order creation event within the pool&#x27;s state: calculating the transaction amounts and fees for the order, and updating the account volumes accordingly.</p>
<p>First, the function processes the list of fills from the <code>OrderInfo</code> object, updating volumes tracked and settling funds for the makers involved. Next, the function retrieves the account&#x27;s total trading volume and active stake. It calculates the taker&#x27;s fee based on the user&#x27;s account stake and volume in DEEP tokens, while the maker fee is retrieved from the governance trade parameters. To receive discounted taker fees, the account must have more than the minimum stake for the pool, and the trading volume in DEEP tokens must exceed the same threshold. If any quantity remains in the <code>OrderInfo</code> object, it is added to the account&#x27;s list of orders as an <code>Order</code> and is already created in <code>Book</code>.</p>
<p>Finally, the function calculates the partial taker fills and maker order quantities, if there are any, with consideration for the taker and maker fees. It adds these to the previously settled and owed balances from the account. Trade history is updated with the total fees collected from the order and two tuples are returned to <code>Pool</code>, settled and owed balances, in (base, quote, DEEP) format, ensuring the correct assets are transferred in <code>Vault</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_uDrR" id="vault-1">Vault<a href="design.html#vault-1" class="hash-link" aria-label="Direct link to Vault" title="Direct link to Vault">​</a></h3>
<p>The <code>settle_balance_manager</code> function in <code>Vault</code> is responsible for managing the transfer of any settled and owed amounts for the <code>BalanceManager</code>.</p>
<p>First, the function validates that a trader is authorized to use the <code>BalanceManager</code>.</p>
<p>Then, for each asset type the process compares <code>balances_out</code> against <code>balances_in</code>. If the <code>balances_out</code> total exceeds <code>balances_in</code>, the function splits the difference from the vault&#x27;s balance and deposits it into the <code>BalanceManager</code>. Conversely, if the <code>balances_in</code> total exceeds <code>balances_out</code>, the function withdraws the difference from the <code>BalanceManager</code> and joins it to the vault&#x27;s balance.</p>
<p>This process is repeated for base, quote, and DEEP asset balances, ensuring all asset balances are accurately reflected and settled between the vault and the <code>BalanceManager</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/MystenLabs/sui/tree/main/docs/docs/../content/standards/deepbookv3/design.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_UIwc" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_ddNZ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="../deepbookv3.html"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">DeepBookV3</div></a><a class="pagination-nav__link pagination-nav__link--next" href="balance-manager.html"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">BalanceManager</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_M9jW thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="design.html#pool" class="table-of-contents__link toc-highlight">Pool shared object</a><ul><li><a href="design.html#book" class="table-of-contents__link toc-highlight">Book</a></li><li><a href="design.html#state" class="table-of-contents__link toc-highlight">State</a></li><li><a href="design.html#vault" class="table-of-contents__link toc-highlight">Vault</a></li><li><a href="design.html#bigvector" class="table-of-contents__link toc-highlight">BigVector</a></li></ul></li><li><a href="design.html#place-limit-order-flow" class="table-of-contents__link toc-highlight">Place limit order flow</a><ul><li><a href="design.html#pool" class="table-of-contents__link toc-highlight">Pool</a></li><li><a href="design.html#book-1" class="table-of-contents__link toc-highlight">Book</a></li><li><a href="design.html#state-1" class="table-of-contents__link toc-highlight">State</a></li><li><a href="design.html#vault-1" class="table-of-contents__link toc-highlight">Vault</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer_BCnt"><div class="footerWrap_s_fg"><div class="footerLogo_uCsX"><a href="https://sui.io" rel="noopener noreferrer" class="footerLogoLink_DDai"><img src="../../img/sui-logo-footer.svg" alt="Sui Logo" class="footer__logo themedComponent_fc7v themedComponent--light_SFoa"><img src="../../img/sui-logo-footer.svg" alt="Sui Logo" class="footer__logo themedComponent_fc7v themedComponent--dark_o7dU"></a></div><div class="footerContent_UF16"><div class="footerLinks_O35S"><a href="https://discord.gg/Sui" target="_blank" rel="noopener noreferrer"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 32C24.8366 32 32 24.8366 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32ZM18.519 8.80985C19.7766 9.02894 20.9792 9.41425 22.1012 9.93555C22.111 9.93957 22.1191 9.94707 22.1239 9.9567C24.1119 12.9198 25.0931 16.2637 24.7265 20.1122C24.7256 20.1203 24.7231 20.1282 24.719 20.1352C24.715 20.1423 24.7095 20.1483 24.703 20.153C23.3695 21.1539 21.8815 21.9153 20.3017 22.4052C20.2905 22.4086 20.2786 22.4084 20.2676 22.4046C20.2566 22.4008 20.247 22.3936 20.2401 22.384C19.9079 21.9149 19.6057 21.4207 19.3418 20.9017C19.3382 20.8946 19.3361 20.8867 19.3357 20.8786C19.3352 20.8706 19.3365 20.8626 19.3394 20.855C19.3422 20.8475 19.3466 20.8407 19.3522 20.8351C19.3578 20.8295 19.3645 20.8251 19.3718 20.8224C19.8507 20.6396 20.3068 20.4197 20.7453 20.1598C20.7531 20.155 20.7597 20.1483 20.7644 20.1403C20.769 20.1323 20.7717 20.1232 20.7722 20.1138C20.7726 20.1045 20.7708 20.0951 20.7669 20.0867C20.7629 20.0782 20.757 20.0709 20.7497 20.0654C20.6566 19.9951 20.5649 19.9218 20.4769 19.8478C20.4689 19.8412 20.4591 19.837 20.4489 19.8358C20.4387 19.8346 20.4283 19.8364 20.419 19.841C17.573 21.1737 14.4542 21.1737 11.5745 19.841C11.5652 19.8367 11.555 19.8351 11.5449 19.8364C11.5348 19.8378 11.5252 19.842 11.5173 19.8485C11.4293 19.9218 11.3369 19.9951 11.2445 20.0654C11.2373 20.071 11.2315 20.0784 11.2277 20.087C11.2239 20.0955 11.2222 20.1049 11.2228 20.1142C11.2233 20.1236 11.2262 20.1326 11.231 20.1406C11.2358 20.1486 11.2425 20.1552 11.2504 20.1598C11.6904 20.4176 12.1494 20.6394 12.6231 20.8231C12.6305 20.8258 12.6372 20.8301 12.6428 20.8356C12.6484 20.8412 12.6527 20.8479 12.6556 20.8554C12.6584 20.8628 12.6597 20.8708 12.6593 20.8788C12.6589 20.8868 12.6568 20.8946 12.6532 20.9017C12.3943 21.4211 12.0935 21.9172 11.7542 22.3848C11.747 22.3941 11.7373 22.4009 11.7263 22.4044C11.7153 22.4079 11.7036 22.4079 11.6926 22.4044C10.1155 21.9132 8.62981 21.1521 7.29783 20.153C7.2915 20.148 7.28623 20.1418 7.28232 20.1346C7.27841 20.1275 7.27595 20.1196 7.2751 20.1115C6.96784 16.7827 7.59336 13.4116 9.87542 9.95519C9.88104 9.94609 9.88923 9.93897 9.89889 9.93479C11.0216 9.41274 12.2242 9.02743 13.4811 8.80834C13.4925 8.80648 13.5041 8.80824 13.5144 8.81337C13.5248 8.8185 13.5334 8.82676 13.5391 8.83704C13.7065 9.13791 13.8576 9.44814 13.9915 9.76632C15.3253 9.561 16.6814 9.561 18.0152 9.76632C18.1355 9.47922 18.307 9.11583 18.461 8.83704C18.4668 8.82688 18.4754 8.8188 18.4858 8.81393C18.4962 8.80906 18.5078 8.80763 18.519 8.80985ZM11.5019 16.2863C11.5019 17.2768 12.2169 18.0844 13.0837 18.0844C13.9644 18.0844 14.6654 17.2776 14.6654 16.2863C14.6794 15.3019 13.971 14.4882 13.0837 14.4882C12.203 14.4882 11.5019 15.2951 11.5019 16.2863ZM17.3501 16.2863C17.3501 17.2768 18.0643 18.0844 18.9318 18.0844C19.8199 18.0844 20.5136 17.2776 20.5136 16.2863C20.5275 15.3019 19.8191 14.4882 18.9318 14.4882C18.0504 14.4882 17.3501 15.2951 17.3501 16.2863Z" fill="#F7F7F8"></path></svg></a><a href="https://x.com/suinetwork" target="_blank" rel="noopener noreferrer"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 32C24.8366 32 32 24.8366 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32ZM23.4785 8L17.5222 15.1983H17.5218L24 25H19.2356L14.8732 18.3996L9.41155 25H8L14.2466 17.4514L8 8H12.7644L16.8952 14.2502L22.0671 8H23.4785ZM14.956 16.5936L15.5889 17.5347V17.5351L19.8997 23.9455H22.0677L16.7851 16.0896L16.1522 15.1484L12.0882 9.10473H9.92015L14.956 16.5936Z" fill="#F7F7F8"></path></svg></a><a href="https://www.youtube.com/@Sui-Network" target="_blank" rel="noopener noreferrer"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 32C24.8366 32 32 24.8366 32 16C32 7.16345 24.8366 0 16 0C7.16345 0 0 7.16345 0 16C0 24.8366 7.16345 32 16 32ZM12.4216 22.5897L16.2654 22.6599C16.2715 22.6599 16.2838 22.6599 16.2837 22.6693C18.4242 22.7093 20.5097 22.5839 22.6442 22.4281C24.3478 22.309 24.7515 21.0753 24.9625 19.6041C25.2255 17.8272 25.2836 16.029 25.146 14.2399C25.1394 14.1551 25.133 14.0695 25.1265 13.9834C24.9983 12.2716 24.8541 10.3478 22.8277 9.99315C22.3965 9.91678 21.9562 9.84968 21.519 9.83741C17.3786 9.7035 13.2014 9.66949 9.05176 9.95651C7.82251 10.0356 7.02764 10.7624 6.82566 11.9804C6.46788 14.1511 6.39448 16.3798 6.58407 18.5688C6.58644 18.5956 6.5888 18.6224 6.59117 18.6494C6.7267 20.1892 6.88506 21.9886 8.70927 22.3607C9.69137 22.5646 10.6913 22.5728 11.6931 22.5809C11.9359 22.5829 12.1788 22.5849 12.4216 22.5897ZM16.0006 17.7909C15.3384 18.1708 14.6747 18.5517 14.0056 18.9352V13.4459C14.7432 13.8683 15.4755 14.2887 16.2087 14.7096C17.0653 15.2013 17.923 15.6937 18.7913 16.1905C17.8572 16.7255 16.9304 17.2573 16.0006 17.7909Z" fill="#F7F7F8"></path></svg></a><a href="https://www.linkedin.com/company/sui-foundation/" target="_blank" rel="noopener noreferrer"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 0C7.16337 0 0 7.16339 0 16C0 24.8366 7.16337 32 16 32C24.8366 32 32 24.8366 32 16C31.9999 7.16339 24.8364 0 16 0ZM11.7311 23.7353H8.21819V12.3859H11.7311V23.7353ZM9.95793 10.8996C8.81063 10.8996 7.88055 9.96193 7.88055 8.80545C7.88055 7.64883 8.81076 6.71123 9.95793 6.71123C11.1051 6.71123 12.0352 7.64883 12.0352 8.80545C12.0352 9.962 11.1052 10.8996 9.95793 10.8996ZM24.8959 23.7353H21.4V17.7778C21.4 16.1438 20.7794 15.2317 19.4873 15.2317C18.0812 15.2317 17.3466 16.1817 17.3466 17.7778V23.7353H13.9773V12.3859H17.3466V13.9145C17.3466 13.9145 18.3601 12.0397 20.7666 12.0397C23.1732 12.0397 24.896 13.5091 24.896 16.549L24.8959 23.7353Z" fill="#F7F7F8"></path></svg></a></div><div class="footerCopy_WbJ_"><div class="text-sm lg:text-xs xl:text-sm mt-2">© 2025 Sui Foundation | Documentation distributed under <a href="https://github.com/MystenLabs/sui/blob/main/docs/site/LICENSE">CC BY 4.0</a></div></div></div></div></footer></div>
<div id="__cookbook" data-api-key="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2NjU5ODBiNDAwZTliZDQ2MzcwZDlhNzYiLCJpYXQiOjE3MTcxNDE2ODQsImV4cCI6MjAzMjcxNzY4NH0.0JCgi4bJ_f6ILFgEyYAP-KeCm1dzOKwH30tC3jEs2_A"></div>

            <script>function initCookbook(){try{window.__cookbook_script&&window.__cookbook_script.remove();const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/@cookbookdev/docsbot/dist/standalone/index.cjs.js",o.async=!0,document.body.appendChild(o),window.__cookbook_script=o}catch(o){console.error("Error while initializing Cookbook:",o)}}</script></body>
</html>